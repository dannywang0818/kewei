<?php
/**
 * Copyright © Magento, Inc. All rights reserved.
 * See COPYING.txt for license details.
 */

// phpcs:disable Magento2.Templates.ThisInTemplate

/**  @var $block \Magento\Checkout\Block\Cart\Grid */
?>
<?php $mergedCells = ($this->helper(Magento\Tax\Helper\Data::class)->displayCartBothPrices() ? 2 : 1); ?>
<?= $block->getChildHtml('form_before') ?>
<form action="<?= $block->escapeUrl($block->getUrl('checkout/cart/updatePost')) ?>"
      method="post"
      id="form-validate"
      data-mage-init='{"Magento_Checkout/js/action/update-shopping-cart":
              {"validationURL" : "<?= $block->escapeUrl($block->getUrl('checkout/cart/updateItemQty')) ?>",
              "updateCartActionContainer": "#update_cart_action_container"}
          }'
      class="form form-cart">
    <?= $block->getBlockHtml('formkey') ?>
    <div class="cart table-wrapper<?= $mergedCells == 2 ? ' detailed' : '' ?>">
        <?php if ($block->getPagerHtml()): ?>
            <div class="cart-products-toolbar cart-products-toolbar-top toolbar"
                 data-attribute="cart-products-toolbar-top"><?= $block->getPagerHtml() ?>
            </div>
        <?php endif ?>
        <table id="shopping-cart-table"
               class="cart items data table"
               data-mage-init='{"shoppingCart":{"emptyCartButton": ".action.clear",
               "updateCartActionContainer": "#update_cart_action_container"}}'>
            <caption class="table-caption"><?= $block->escapeHtml(__('Shopping Cart Items')) ?></caption>
            <thead>
            <tr>
                <th class="col checkbox" scope="col"><span></span></th>
                <th class="col item" scope="col"><span><?= $block->escapeHtml(__('Item')) ?></span></th>
                <th class="col price" scope="col"><span><?= $block->escapeHtml(__('Price')) ?></span></th>
                <th class="col qty" scope="col"><span><?= $block->escapeHtml(__('Qty')) ?></span></th>
                <th class="col subtotal" scope="col"><span><?= $block->escapeHtml(__('Subtotal')) ?></span></th>
            </tr>
            </thead>
            <?php foreach ($block->getItems() as $_item): ?>
                <?= $block->getItemHtml($_item) ?>
            <?php endforeach ?>
        </table>
        <?php if ($block->getPagerHtml()): ?>
            <div class="cart-products-toolbar cart-products-toolbar-bottom toolbar"
                 data-attribute="cart-products-toolbar-bottom"><?= $block->getPagerHtml() ?>
            </div>
        <?php endif ?>
    </div>
    <div class="cart main actions">
        <?php if ($block->getContinueShoppingUrl()): ?>
            <a class="action continue"
               href="<?= $block->escapeUrl($block->getContinueShoppingUrl()) ?>"
               title="<?= $block->escapeHtml(__('Continue Shopping')) ?>">
                <span><?= $block->escapeHtml(__('Continue Shopping')) ?></span>
            </a>
        <?php endif; ?>
        <?php if ($block->getViewModel()->isClearShoppingCartEnabled()): ?>
            <button type="button"
                    name="update_cart_action"
                    data-cart-empty=""
                    value="empty_cart"
                    title="<?= $block->escapeHtml(__('Clear Shopping Cart')) ?>"
                    class="action clear" id="empty_cart_button">
                <span><?= $block->escapeHtml(__('Clear Shopping Cart')) ?></span>
            </button>
        <?php endif ?>
        <button type="submit"
                name="update_cart_action"
                data-cart-item-update=""
                value="update_qty"
                title="<?= $block->escapeHtml(__('Update Shopping Cart')) ?>"
                class="action update">
            <span><?= $block->escapeHtml(__('Update Shopping Cart')) ?></span>
        </button>
        <input type="hidden" value="" id="update_cart_action_container" data-cart-item-update=""/>
    </div>
</form>
<?= $block->getChildHtml('checkout.cart.order.actions') ?>
<?= $block->getChildHtml('shopping.cart.table.after') ?>


<script>
    require([
        'jquery',
        'Magento_Checkout/js/model/quote',
        'mage/storage',
        'Magento_Checkout/js/model/shipping-service',
        'Magento_Checkout/js/model/resource-url-manager',
    ], function ($, quote,
                 storage,
                 shippingService,
                 resourceUrlManager) {
        $(function () { // to ensure that code evaluates on page load


            let generateFormJson = function () {

                const formArray = $('#form-validate').serializeArray();

                const cartItems = [];
                const formJson = {}
                for (const formElement of formArray) {


                    const name = formElement.name;
                    const elementValue = formElement.value;

                    // if element's name is like 'cart[8][qty]', format it as a cart item.
                    if (/\S*\[\S*\]/.test(name) && name.match(/^[^\s\[]+/)[0] === 'cart') {

                        const regex = /\[([^\s\[\]]+)\]/g;
                        const found = name.matchAll(regex);
                        const valArray = [];
                        for (const match of found) {
                            valArray.push(match[1]);
                        }
                        cartItems.push({item_id: valArray[0], [valArray[1]]: elementValue});
                    } else {
                        formJson[name] = elementValue;
                    }
                }

                formJson['cart'] = {};
                formJson['cart']['items'] = cartItems;
                console.log(formJson);
                return formJson;
            }


            $('.action.plus').on("click", function () {
                shippingService.isLoading(true);
                quote.setTotals(JSON.parse(
                    "{\"grand_total\":215,\"base_grand_total\":215,\"subtotal\":444,\"base_subtotal\":444,\"discount_amount\":-36,\"base_discount_amount\":-36,\"subtotal_with_discount\":180,\"base_subtotal_with_discount\":180,\"shipping_amount\":35,\"base_shipping_amount\":35,\"shipping_discount_amount\":0,\"base_shipping_discount_amount\":0,\"tax_amount\":0,\"base_tax_amount\":0,\"weee_tax_applied_amount\":null,\"shipping_tax_amount\":0,\"base_shipping_tax_amount\":0,\"subtotal_incl_tax\":444,\"base_subtotal_incl_tax\":444,\"shipping_incl_tax\":35,\"base_shipping_incl_tax\":35,\"base_currency_code\":\"CNY\",\"quote_currency_code\":\"CNY\",\"items_qty\":7,\"items\":[{\"item_id\":7,\"price\":12,\"base_price\":12,\"qty\":3,\"row_total\":36,\"base_row_total\":36,\"row_total_with_discount\":0,\"tax_amount\":0,\"base_tax_amount\":0,\"tax_percent\":0,\"discount_amount\":0,\"base_discount_amount\":0,\"discount_percent\":0,\"price_incl_tax\":12,\"base_price_incl_tax\":12,\"row_total_incl_tax\":36,\"base_row_total_incl_tax\":36,\"options\":\"[]\",\"weee_tax_applied_amount\":null,\"weee_tax_applied\":null,\"name\":\"Dual Handle Cardio Ball\"},{\"item_id\":8,\"price\":45,\"base_price\":45,\"qty\":4,\"row_total\":180,\"base_row_total\":180,\"row_total_with_discount\":0,\"tax_amount\":0,\"base_tax_amount\":0,\"tax_percent\":0,\"discount_amount\":36,\"base_discount_amount\":36,\"discount_percent\":20,\"price_incl_tax\":45,\"base_price_incl_tax\":45,\"row_total_incl_tax\":180,\"base_row_total_incl_tax\":180,\"options\":\"[{\\\"value\\\":\\\"L\\\",\\\"label\\\":\\\"Size\\\"},{\\\"value\\\":\\\"Blue\\\",\\\"label\\\":\\\"Color\\\"}]\",\"weee_tax_applied_amount\":null,\"weee_tax_applied\":null,\"name\":\"Proteus Fitness Jackshirt\"}],\"total_segments\":[{\"code\":\"subtotal\",\"title\":\"小计\",\"value\":444},{\"code\":\"discount\",\"title\":\"折扣\",\"value\":-36},{\"code\":\"shipping\",\"title\":\"航运及处理 (Flat Rate - Fixed)\",\"value\":35},{\"code\":\"tax\",\"title\":\"税\",\"value\":0,\"extension_attributes\":{\"tax_grandtotal_details\":[]}},{\"code\":\"grand_total\",\"title\":\"总额\",\"value\":215,\"area\":\"footer\"}]}"
                ));

                const $qty = $(this).prev().find('input');
                let v = new Number($qty.val());
                if (v + 1 > 1) {
                    $(this).parent().children('.action.minus').prop('disabled', false);
                }
                $qty.val(v + 1);



                const serviceUrl = resourceUrlManager.getUrlForKeweiCartManagement(quote);


                storage.put(
                    serviceUrl, JSON.stringify(generateFormJson()), false,
                ).done(function (result) {
                    // rateRegistry.set(address.getCacheKey(), result);
                    // shippingService.setShippingRates(result);
                    console.log(result, '#######');
                }).fail(function (response) {
                    // shippingService.setShippingRates([]);
                    // errorProcessor.process(response);
                    console.log(response, '$$$$$$$$4');
                }).always(function () {
                    console.log('%%%%%%%%%%%');
                    // shippingService.isLoading(false);
                });
            });

            $('.action.minus').on("click", function () {
                console.log('!!!!!!!');
                let $qty = $(this).next().find('input');
                let v = new Number($qty.val());
                if (v - 1 === 1) {
                    $(this).prop('disabled', true);
                }
                $qty.val(v - 1);
            });
        });
    });
</script>
